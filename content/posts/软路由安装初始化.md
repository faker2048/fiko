+++
date = '2025-06-24T08:28:32+08:00'
draft = true
title = '软路由安装初始化'
+++

# 软路由安装完整教程

> 本教程专为计算机基础知识有限的用户编写，将一步步指导您完成软路由的安装配置。

## 📋 准备工作

### 所需硬件
- **一台电脑**：推荐至少4GB内存，双网卡（有线网卡）
- **U盘**：至少16GB容量，用于制作启动盘
- **网线**：连接电脑和光猫/路由器

### 所需软件下载
1. **Ventoy**：用于制作启动盘
   - 下载地址：https://www.ventoy.net/cn/download.html
   - 选择Windows版本下载

2. **Windows Server 2022**：服务器操作系统
   - 官方下载：https://www.microsoft.com/zh-cn/evalcenter/download-windows-server-2022
   - 选择ISO文件下载

3. **ImmortalWrt 23.05**：路由器固件
   - 下载地址：https://downloads.immortalwrt.org/releases/23.05.4/targets/x86/64/
   - 选择：immortalwrt-23.05.4-x86-64-generic-ext4-combined.vhdx.gz（专为虚拟机优化）

## 🔧 第一步：使用Ventoy制作启动盘并安装Windows Server 2022

### 1.1 制作Ventoy启动盘

1. **插入U盘**到电脑，备份U盘中的重要数据（制作过程会格式化U盘）

2. **解压并运行Ventoy**
   - 解压下载的Ventoy压缩包
   - 双击运行 `Ventoy2Disk.exe`
   - 如提示安全警告，选择"允许"

3. **制作启动盘**
   - 在Ventoy界面中选择您的U盘
   - 点击"安装"按钮
   - 确认格式化警告，点击"确定"
   - 等待制作完成

4. **复制系统镜像**
   - 制作完成后，U盘会出现一个可访问的分区
   - 将下载的`Windows Server 2022 ISO文件`复制到U盘
   - 将下载的`immortalwrt-23.05.4-x86-64-generic-ext4-combined.vhdx.gz`也复制到U盘

### 1.2 安装Windows Server 2022

1. **设置BIOS启动**
   - 重启电脑，开机时按`F2`、`F12`或`Del`键进入BIOS（不同品牌按键不同）
   - 找到"Boot"或"启动"选项
   - 将U盘设为第一启动项
   - 保存并退出BIOS

2. **启动Ventoy**
   - 电脑重启后会看到Ventoy启动菜单
   - 选择"Windows Server 2022"镜像
   - 按回车键开始安装

3. **安装Windows Server 2022**
   - 选择语言：中文（简体）
   - 点击"现在安装"
   - 选择版本：推荐"Windows Server 2022 Standard（桌面体验）"
   - 接受许可条款
   - 选择"自定义：仅安装Windows"
   - 选择安装磁盘，点击"下一步"
   - 等待安装完成（约30-60分钟）

4. **初始配置**
   - 安装完成后设置管理员密码（请记住此密码）
   - 登录系统，完成基本设置

## 🖥️ 第二步：开启Hyper-V并创建虚拟机

### 2.1 启用Hyper-V功能

1. **打开服务器管理器**
   - 登录Windows Server后，服务器管理器会自动打开
   - 如未打开，点击任务栏的"服务器管理器"图标

2. **添加角色和功能**
   - 在服务器管理器中，点击"添加角色和功能"
   - 点击"下一步"直到"服务器角色"页面
   - 勾选"Hyper-V"
   - 系统会提示添加所需功能，点击"添加功能"
   - 继续点击"下一步"
   - 在"功能"页面，确保"Hyper-V"相关功能已选中
   - 点击"安装"，等待安装完成
   - 安装完成后，重启服务器

### 2.2 配置虚拟交换机

> 💡 **重要概念**：软路由需要两个网口，一个连接上级路由器/光猫（WAN口），一个连接内网设备（LAN口）。我们需要创建两个虚拟交换机来模拟这两个网口。

1. **打开Hyper-V管理器**
   - 重启后，在开始菜单搜索"Hyper-V管理器"并打开

2. **创建WAN虚拟交换机（连接外网）**
   - 在右侧操作面板，点击"虚拟交换机管理器"
   - 选择"外部"交换机类型
   - 点击"创建虚拟交换机"
   - **名称**：输入"WAN-Switch"
   - **连接类型**：选择"外部网络"，选择连接到上级路由器/光猫的网卡
   - ✅ **勾选**"允许管理操作系统共享此网络适配器"
   - 点击"确定"

3. **创建LAN虚拟交换机（连接内网）**
   - 再次点击"虚拟交换机管理器"
   - 选择"外部"交换机类型
   - 点击"创建虚拟交换机"
   - **名称**：输入"LAN-Switch"
   - **连接类型**：选择"外部网络"，选择连接到内网的网卡（如果有第二块网卡）
   - ❌ **不要勾选**"允许管理操作系统共享此网络适配器"
   - 点击"确定"

   > 🔍 **重要说明**：
   > - **WAN交换机共享**：允许宿主机也能通过上级路由器上网，不会冲突
   > - **LAN交换机不共享**：确保软路由完全控制内网，避免IP冲突和安全问题
   > - **网络隔离**：宿主机通过WAN口上网，内网设备通过软路由的LAN口管理

   > ⚠️ **网卡需求**：
   > - 如果只有一块网卡：LAN-Switch设为"内部"类型
   > - 如果有两块网卡：WAN用第一块，LAN用第二块（推荐）

### 2.3 创建第二代虚拟机

1. **新建虚拟机**
   - 在Hyper-V管理器中，右键服务器名称
   - 选择"新建" > "虚拟机"

2. **配置虚拟机基本信息**
   - **名称**：输入"OpenWrt-Router"
   - **位置**：使用默认位置
   - **代系**：选择"第2代"（重要！）
   - **内存**：分配至少512MB（推荐1GB）
   - **网络连接**：先选择"WAN-Switch"（稍后会添加第二个网卡）
   - **虚拟硬盘**：创建虚拟硬盘，大小8GB足够
   - 点击"完成"

3. **添加第二个网络适配器**
   - 右键新创建的虚拟机，选择"设置"
   - 点击"添加硬件"
   - 选择"网络适配器"，点击"添加"
   - 在新添加的网络适配器中，选择"LAN-Switch"
   - 点击"确定"

4. **关闭安全启动**
   - 在虚拟机设置中，选择"安全"
   - ❌ 取消勾选"启用安全启动"
   - 点击"确定"

   > 🔍 **网卡配置总结**：
   > - **网络适配器1**：连接到"WAN-Switch"，用作WAN口（连接上级网络）
   > - **网络适配器2**：连接到"LAN-Switch"，用作LAN口（连接内网设备）

## 🌐 第三步：安装和配置OpenWrt系统

### 3.1 准备OpenWrt镜像

1. **解压VHDX固件**
   - 将U盘重新插入服务器
   - 解压`immortalwrt-23.05.4-x86-64-generic-ext4-combined.vhdx.gz`文件
   - 得到`.vhdx`虚拟硬盘文件（专为Hyper-V优化）

   > 💡 **优势说明**：VHDX格式是微软专为Hyper-V虚拟机设计的格式，比IMG格式有更好的性能和兼容性，无需额外转换步骤。

### 3.2 安装OpenWrt

1. **替换虚拟硬盘**
   - 在Hyper-V管理器中，右键"OpenWrt-Router"虚拟机
   - 选择"设置"
   - 选择"SCSI控制器"
   - 点击现有的"硬盘驱动器"
   - 点击"浏览"，选择解压得到的`.vhdx`文件
   - 点击"确定"

   > 💡 **说明**：VHDX文件本身就是一个完整的虚拟硬盘，包含了完整的OpenWrt系统，无需安装过程。

2. **启动虚拟机**
   - 右键虚拟机，选择"启动"
   - 双击虚拟机名称打开控制台窗口
   - OpenWrt会直接启动

3. **等待系统启动**
   - 系统会直接从VHDX文件启动（无需安装过程）
   - 启动完成后会看到OpenWrt的命令行界面
   - 出现类似 `root@ImmortalWrt:~#` 的提示符表示启动成功

### 3.3 网络接口配置

> 💡 **关键步骤**：需要根据网卡的MAC地址来正确分配WAN和LAN接口，这是软路由配置的核心！

1. **查看网络接口信息**
   ```bash
   ip addr show
   ```
   
   会显示类似以下信息：
   ```
   2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500
       link/ether 00:15:5d:xx:xx:xx brd ff:ff:ff:ff:ff:ff
   3: eth1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500
       link/ether 00:15:5d:yy:yy:yy brd ff:ff:ff:ff:ff:ff
   ```
   
   **记录下两个网卡的MAC地址**（link/ether后面的地址）

2. **确定网卡对应关系**
   - 回到Windows Server的Hyper-V管理器
   - 右键虚拟机选择"设置"
   - 查看每个网络适配器的"MAC地址"
   - **第1个网络适配器**（连接WAN-Switch）的MAC = WAN口
   - **第2个网络适配器**（连接LAN-Switch）的MAC = LAN口

3. **编辑网络配置文件**
   ```bash
   vi /etc/config/network
   ```

4. **配置WAN和LAN接口**
   找到并修改网络配置（用实际的MAC地址替换示例中的地址）：
   
   ```bash
   # WAN接口配置（连接上级路由器）
   config interface 'wan'
       option ifname 'eth0'  # 替换为WAN网卡对应的接口名
       option proto 'dhcp'   # 自动获取IP地址
   
   # LAN接口配置（内网管理）
   config interface 'lan'
       option ifname 'eth1'  # 替换为LAN网卡对应的接口名
       option proto 'static'
       option ipaddr '192.168.10.1'    # 软路由管理IP
       option netmask '255.255.255.0'
       option ip6assign '60'
   ```

   > ⚠️ **重要说明**：
   > - 确保WAN接口使用连接到"WAN-Switch"的网卡
   > - 确保LAN接口使用连接到"LAN-Switch"的网卡
   > - 可以修改LAN的IP段（如192.168.10.1）避免与上级路由器冲突

5. **重启网络服务**
   ```bash
   /etc/init.d/network restart
   ```

6. **启用Web管理界面**
   ```bash
   /etc/init.d/uhttpd start
   /etc/init.d/uhttpd enable
   ```

7. **检查配置是否生效**
   ```bash
   # 查看接口状态
   ip route show
   
   # 测试WAN连接
   ping 8.8.8.8
   ```

## 🔗 第四步：访问和完善配置

### 4.1 首次登录Web界面

1. **连接到LAN网络**
   - 在Windows Server的网络设置中找到"LAN-Switch"对应的网络适配器
   - 设置该适配器为自动获取IP地址，或手动设置为192.168.10.x网段

2. **访问路由器管理界面**
   - 在Windows Server的浏览器中访问：`http://192.168.10.1`
   - 首次登录用户名：`root`，密码：空（直接点登录）

3. **设置管理密码**
   - 登录后立即设置管理员密码
   - 进入"System" > "Administration"
   - 设置新密码并保存

   > 🔍 **网络连接说明**：
   > - WAN口自动从上级路由器获取IP（如192.168.1.100）
   > - LAN口使用我们设置的IP（192.168.10.1）
   > - 内网设备连接到LAN网络，获取192.168.10.x的IP地址

### 4.2 Web界面网络配置详解

1. **验证接口配置**
   - 进入"Network" > "Interfaces"
   - 确认看到以下接口：
     - **WAN接口**：显示为"Connected"，IP地址来自上级路由器
     - **LAN接口**：显示为"Connected"，IP地址为192.168.10.1

2. **如果需要重新配置接口**
   
   **配置WAN接口**：
   - 点击WAN接口的"Edit"
   - **Protocol**: 选择"DHCP client"（自动获取IP）
   - **Physical Settings**: 确保选择了正确的网卡（对应WAN-Switch的MAC地址）
   - 点击"Save & Apply"

   **配置LAN接口**：
   - 点击LAN接口的"Edit"
   - **Protocol**: 选择"Static address"
   - **IPv4 address**: 192.168.10.1
   - **IPv4 netmask**: 255.255.255.0
   - **Physical Settings**: 确保选择了正确的网卡（对应LAN-Switch的MAC地址）
   - 点击"Save & Apply"

3. **配置DHCP服务器**
   - 进入"Network" > "DHCP and DNS"
   - 在"Server Settings"中找到LAN接口
   - 设置DHCP地址池：
     - **Start**: 192.168.10.100
     - **Limit**: 100（可分配100个IP地址）
     - **Lease time**: 12h
   - 点击"Save & Apply"

4. **配置防火墙规则**
   - 进入"Network" > "Firewall"
   - 确认"Zone Forwardings"中有：
     - **From**: lan **To**: wan **Action**: ACCEPT
   - 这允许内网设备通过WAN接口访问互联网

       > 🔍 **完整网络架构**：
    > ```
    > 互联网
    >   ↕
    > [上级路由器/光猫] (192.168.1.1)
    >   ↕
    > [物理网卡1] ← WAN-Switch(共享) → [Windows Server] (192.168.1.100)
    >   ↕                                      ↕
    > [软路由WAN口] (192.168.1.101)          管理和上网
    >   ↕
    > [软路由系统] OpenWrt
    >   ↕
    > [软路由LAN口] (192.168.10.1)
    >   ↕
    > [物理网卡2] ← LAN-Switch(不共享)
    >   ↕
    > [内网设备] (192.168.10.100-200)
    > ```
    > 
    > **网络隔离优势**：
    > - 宿主机和软路由都能独立上网
    > - 内网完全由软路由控制，无IP冲突
    > - 管理更清晰，故障排除更容易

### 4.3 测试网络连通性

1. **测试内网连接**
   - 用另一台设备连接到软路由
   - 检查是否能获取IP地址

2. **测试外网连接**
   - 在连接的设备上测试是否能访问互联网

## ⚠️ 重要注意事项

### 安全提醒
- 🔐 务必为所有账户设置强密码
- 🔄 定期更新系统和固件
- 🚫 不要在生产环境中使用默认密码

### 故障排除

**虚拟化相关**：
- **无法启动虚拟机**：检查BIOS是否启用虚拟化技术（Intel VT-x或AMD-V）
- **性能问题**：确保宿主机有足够的内存和CPU资源

**网络配置相关**：
- **无法访问管理界面**：
  - 检查Windows Server是否连接到LAN-Switch网络
  - 确认LAN接口IP设置正确（192.168.10.1）
  - 尝试用命令行ping 192.168.10.1测试连通性

- **WAN口无法获取IP**：
  - 检查WAN-Switch是否连接到正确的物理网卡
  - 确认上级路由器/光猫工作正常
  - 在OpenWrt中查看WAN接口状态

- **内网设备无法上网**：
  - 检查防火墙规则是否允许lan到wan的转发
  - 确认DHCP服务器是否正常工作
  - 检查DNS设置（可使用8.8.8.8）

- **IP地址冲突**：
  - 确认LAN-Switch没有开启"允许管理操作系统共享"
  - 检查宿主机和软路由是否在不同网段
  - 软路由LAN口应使用独立网段（如192.168.10.x）

- **网卡对应错误**：
  - 使用`ip addr show`查看MAC地址
  - 在Hyper-V中核对虚拟网卡的MAC地址
  - 重新编辑/etc/config/network文件

**常用调试命令**：
```bash
# 查看接口状态
ip addr show

# 查看路由表
ip route show

# 测试网络连通性
ping 8.8.8.8

# 查看防火墙状态
iptables -L

# 重启网络服务
/etc/init.d/network restart
```

### 备份建议
- 📁 定期备份虚拟机文件
- ⚙️ 导出OpenWrt配置文件
- 💾 保存重要的网络配置信息

## 🎯 第五步：后续优化（可选）

1. **性能优化**
   - 调整虚拟机内存分配
   - 优化网络驱动设置

2. **功能扩展**
   - 安装额外的OpenWrt插件
   - 配置高级网络功能

3. **监控管理**
   - 设置系统监控
   - 配置日志记录

---

## 📞 获取帮助

如果在安装过程中遇到问题，可以：
- 查看OpenWrt官方文档
- 访问相关技术论坛
- 寻求专业技术支持

**恭喜！您已经完成了软路由的基本安装配置。现在可以享受自定义路由器带来的强大功能了！** 🎉 